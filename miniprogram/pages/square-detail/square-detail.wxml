<view class="post-detail">
    <notify-banner />
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="post-header">
        <image class="back-btn" src="/assets/icons/fanhui.svg" bindtap="goBack" />
        <image class="user-avatar" src="{{post.avatar_url}}" mode="aspectFill" />
        <view class="username-area">
            <text class="username {{post.isVip ? 'vip-username' : ''}}">{{post.username}}</text>
            <image wx:if="{{post.isVip}}" src="/assets/icons/vip-2.svg" class="vip-badge" />
        </view>
    </view>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <scroll-view class="main-content" scroll-y="true" enable-flex="true">
        <view class="post-content">
            <text class="post-title">{{post.content}}</text>
            <block wx:if="{{post.images.length > 0}}">
                <!-- å•å¼ å›¾ç‰‡ -->
                <view class="post-images" wx:if="{{post.images.length === 1}}">
                    <block wx:if="{{post.images[0].status === 'pass'}}">
                        <image src="{{post.images[0].url}}" class="single-image" mode="widthFix" bindtap="previewImage" data-current="{{post.images[0].url}}" data-urls="{{post.imageUrls}}" />
                    </block>
                    <block wx:elif="{{post.images[0].status === 'fail'}}">
                        <view class="post-image failed-placeholder">å›¾ç‰‡è¿è§„</view>
                    </block>
                    <block wx:else>
                        <view class="post-image audit-placeholder">å›¾ç‰‡å®¡æ ¸ä¸­</view>
                    </block>
                </view>

                <!-- 2 å¼ å›¾ç‰‡ï¼ˆä¸¤å¼ å¹¶æ’ï¼‰ -->
                <view class="image-grid two-grid" wx:elif="{{post.images.length === 2}}">
                    <block wx:for="{{post.images}}" wx:key="index">
                        <block wx:if="{{item.status === 'pass'}}">
                            <image src="{{item.url}}" class="grid-image" bindtap="previewImage" data-current="{{item.url}}"  data-urls="{{post.imageUrls}}" />
                        </block>
                        <block wx:elif="{{item.status === 'fail'}}">
                            <view class="grid-image failed-placeholder">å›¾ç‰‡è¿è§„</view>
                        </block>
                        <block wx:else>
                            <view class="grid-image audit-placeholder">å®¡æ ¸ä¸­</view>
                        </block>
                    </block>
                </view>

                <!-- 3 å¼ å›¾ç‰‡ï¼ˆ3 å®«æ ¼ï¼‰ -->
                <view class="image-grid three-grid" wx:elif="{{post.images.length === 3}}">
                    <block wx:for="{{post.images}}" wx:key="index">
                        <block wx:if="{{item.status === 'pass'}}">
                            <image src="{{item.url}}" class="grid-image" bindtap="previewImage" data-current="{{item.url}}"  data-urls="{{post.imageUrls}}" />
                        </block>
                        <block wx:elif="{{item.status === 'fail'}}">
                            <view class="grid-image failed-placeholder">å›¾ç‰‡è¿è§„</view>
                        </block>
                        <block wx:else>
                            <view class="grid-image audit-placeholder">å®¡æ ¸ä¸­</view>
                        </block>
                    </block>
                </view>

                <!-- 4 å¼ å›¾ç‰‡ï¼ˆç‰¹æ®Š 2x2 å¤„ç†ï¼‰ -->
                <view class="image-grid four-grid" wx:elif="{{post.images.length === 4}}">
                    <block wx:for="{{post.images}}" wx:key="index">
                        <block wx:if="{{item.status === 'pass'}}">
                            <image src="{{item.url}}" class="grid-image" bindtap="previewImage" data-current="{{item.url}}"  data-urls="{{post.imageUrls}}" />
                        </block>
                        <block wx:elif="{{item.status === 'fail'}}">
                            <view class="grid-image failed-placeholder">å›¾ç‰‡è¿è§„</view>
                        </block>
                        <block wx:else>
                            <view class="grid-image audit-placeholder">å®¡æ ¸ä¸­</view>
                        </block>
                    </block>
                </view>

                <!-- 5-9 å¼ å›¾ç‰‡ï¼ˆä¹å®«æ ¼ï¼‰ -->
                <view class="image-grid nine-grid" wx:elif="{{post.images.length >= 5}}">
                    <block wx:for="{{post.images}}" wx:key="index">
                        <block wx:if="{{item.status === 'pass'}}">
                            <image src="{{item.url}}" class="grid-image" bindtap="previewImage" data-current="{{item.url}}"  data-urls="{{post.imageUrls}}" />
                        </block>
                        <block wx:elif="{{item.status === 'fail'}}">
                            <view class="grid-image failed-placeholder">å›¾ç‰‡è¿è§„</view>
                        </block>
                        <block wx:else>
                            <view class="grid-image audit-placeholder">å®¡æ ¸ä¸­</view>
                        </block>
                    </block>
                </view>
            </block>
        </view>

        <!-- ä¿¡æ¯åŒº -->
        <view class="post-information">
            <view class="post-info">
                <text class="post-time">{{post.created_time}}</text>
                <text class="post-category">#{{post.category}}</text>


            </view>
            <!-- âœ… ç‚¹èµæŒ‰é’® -->
            <view class="post-like" bindtap="toggleLike">
                <image class="like-icon" src="{{post.isLiked ? '/assets/icons/heart-fill.svg' : '/assets/icons/heart-line.svg'}}" />
                <text>{{post.likes_count}}</text>
            </view>
        </view>

        <!-- è¯„è®ºåŒº -->
        <view class="comment-section">
            <view class="comment-title">
                <text>è¯„è®ºåŒº</text>
            </view>

            <block wx:for="{{comments}}" wx:key="id">
                <view class="comment-item" bindtap="handleReply" data-commentid="{{item.id}}" data-username="{{item.username}}" data-parentid="{{item.parent_id}}" data-rootid="{{item.root_parent_id}}">
                    <image class="comment-avatar" src="{{item.avatar_url}}" mode="aspectFill" />
                    <view class="comment-content">
                        <view class="comment-main">
                            <text class="comment-username {{item.isVip ? 'vip-username' : ''}}">{{item.username}}</text>
                            <text class="comment-text">{{item.content}}</text>
                            <view class="comment-row">
                                <text class="comment-time">{{item.created_time}}</text>
                                <view class="comment-actions">
                                    <image class="like-icon" src="{{item.isLiked ? '/assets/icons/heart-fill.svg' : '/assets/icons/heart-line.svg'}}" catchtap="toggleCommentLike" data-commentid="{{item.id}}" data-isliked="{{item.isLiked}}" />
                                    <text>{{item.likes_count}}</text>
                                </view>
                            </view>
                        </view>

                    </view>
                </view>

                <!-- ğŸ”¹ äºŒçº§è¯„è®º -->
                <block wx:if="{{item.children.length > 0}}">
                    <view class="sub-comments">
                        <block wx:for="{{item.children}}" wx:key="id">
                            <view class="sub-comment-item" bindtap="handleReply" data-commentid="{{item.id}}" data-username="{{item.username}}" data-parentid="{{item.parent_id}}" data-rootid="{{item.root_parent_id}}">
                                <image class="sub-comment-avatar" src="{{item.avatar_url}}" mode="aspectFill" />
                                <view class="sub-comment-content">
                                    <view class="comment-main">
                                        <view class="comment-header">
                                            <text class="comment-username {{item.isVip ? 'vip-username' : ''}}">{{item.username}} å›å¤ {{item.reply_to_username}}</text>
                                        </view>
                                        <text class="comment-text">{{item.content}}</text>
                                        <view class="comment-row">
                                            <text class="comment-time">{{item.created_time}}</text>
                                            <view class="comment-actions">
                                                <image class="like-icon" src="{{item.isLiked ? '/assets/icons/heart-fill.svg' : '/assets/icons/heart-line.svg'}}" catchtap="toggleCommentLike" data-commentid="{{item.id}}" data-isliked="{{item.isLiked}}" />
                                                <text>{{item.likes_count}}</text>
                                            </view>
                                        </view>
                                    </view>
                                </view>
                            </view>
                        </block>
                    </view>
                </block>
            </block>
        </view>
    </scroll-view>
    <!-- å‡è¾“å…¥æ¡†ï¼ˆå¸åº•ï¼‰ -->
    <view class="fake-input-bar" bindtap="openCommentPopup">
        <text class="fake-placeholder">{{replyPlaceholder}}</text>
        <text class="fake-send">å‘è¡¨</text>
    </view>

    <!-- è¯„è®ºå¼¹çª—ï¼ˆå±…ä¸­ç‰ˆï¼‰ -->
    <view class="comment-popup" wx:if="{{showCommentPopup}}">
        <view class="popup-mask" bindtap="closeCommentPopup"></view>
        <view class="popup-content centered-popup">
            <textarea class="popup-textarea" placeholder="{{replyPlaceholder}}" value="{{newComment}}" bindinput="handleInput" focus></textarea>
            <view class="popup-actions">
                <button class="cancel-btn" bindtap="closeCommentPopup">å–æ¶ˆ</button>
                <button class="submit-btn" bindtap="submitComment">å‘é€</button>
            </view>
        </view>
    </view>
</view>