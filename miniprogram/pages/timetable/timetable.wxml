<view class="timetable-container">

    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <view class="header">
        <image class="back-btn" src="/assets/icons/fanhui.svg" bindtap="handleBack" />

        <!-- æ˜¾ç¤ºå½“å‰å‘¨æ•° -->
        <picker mode="selector" range="{{weeksRange}}" bindchange="onWeekChange">
            <text class="current-week">{{weeksRange[currentWeek - 1]}} â–¼</text>
        </picker>
    </view>

    <!-- é€‰é¡¹å¡ï¼šæ—¥è¯¾è¡¨ / å‘¨è¯¾è¡¨ -->
    <view class="top-bar">
        <view class="tab {{selectedTab === 'daily' ? 'active' : ''}}" bindtap="switchToDaily">æ—¥è¯¾è¡¨</view>
        <view class="tab {{selectedTab === 'weekly' ? 'active' : ''}}" bindtap="switchToWeekly">å‘¨è¯¾è¡¨</view>
    </view>

    <!-- é®ç½©å±‚ï¼ˆç‚¹å‡»å¯å…³é—­èœå•ï¼‰ -->
    <view wx:if="{{showMenu}}" class="overlay" bindtap="closeMenu"></view>

    <!-- èœå•å¼¹çª— -->
    <view wx:if="{{showMenu}}" class="menu-popup">
        <view class="menu-item" bindtap="openImportModal">ğŸ“¥ å¯¼å…¥è¯¾è¡¨</view>
        <view class="menu-item" bindtap="openSettings">âš™ï¸ è®¾ç½®</view>
        <view class="menu-item" bindtap="closeMenu">âŒ å…³é—­</view>
    </view>

    <!-- å¯¼å…¥è¯¾è¡¨å¼¹çª— -->
    <view wx:if="{{showImportModal}}" class="import-modal">
        <view class="modal-content">
            <text class="modal-title">å¯¼å…¥è¯¾è¡¨</text>
            <input class="input-box" placeholder="è¯·è¾“å…¥æ•™åŠ¡ç³»ç»Ÿè´¦å·" bindinput="onUsernameInput" />
            <input class="input-box" placeholder="è¯·è¾“å…¥å¯†ç " bindinput="onPasswordInput" password="true" />
            <button class="import-button" bindtap="importSchedule">æäº¤</button>
            <button class="cancel-button" bindtap="closeImportModal">å–æ¶ˆ</button>
        </view>
    </view>

    <!-- è¯¾ç¨‹åˆ—è¡¨ -->
    <view class="course-list" wx:if="{{selectedTab === 'daily'}}">
        <view class="swipe-wrapper" bindtouchstart="handleTouchStart" bindtouchend="handleTouchEnd">
            <!-- æ—¥æœŸé€‰æ‹© & ç¼–è¾‘èœå• -->
            <view class="date-selector">
                <text class="day-of-week">{{dayOfWeek}}</text>
                <picker mode="date" value="{{selectedDate}}" bindchange="onDateChange">
                    <text class="selected-date">{{selectedDate}}</text>
                </picker>
                <image class="menu-icon" src="/assets/icons/menu-dots-svgrepo-com.svg" bindtap="openMenu" />
            </view>

            <view wx:if="{{!timetableConfigLoaded}}" class="config-tip">
                ğŸ“Œ è¯·å…ˆç‚¹å‡»å³ä¸Šè§’èœå•è¿›è¡Œè¯¾è¡¨é…ç½®ï¼Œå†ç‚¹å‡»å¯¼å…¥è¯¾è¡¨
            </view>

            <!-- å¦‚æœä»Šå¤©æ²¡è¯¾ï¼Œæ˜¾ç¤ºä¼‘æ¯æç¤º -->
            <view wx:if="{{noClassesToday}}" class="no-class-box">
                ğŸ‰ ä»Šå¤©æ²¡è¯¾ï¼Œå¿«å»ç©å§ ğŸ˜
            </view>
            <view wx:if="{{hasPractice}}" class="practice-alert">
                ğŸ”” æœ¬å‘¨æœ‰å®è·µè¯¾
                <text class="practice-detail" bindtap="viewPracticeDetails">æŸ¥çœ‹è¯¦æƒ…</text>
            </view>


            <!-- è¯¾ç¨‹åˆ—è¡¨ -->
            <view wx:if="{{!noClassesToday}}" class="course-list">
                <block wx:for="{{courses}}" wx:key="index">
                    <view class="course-item" bindtap="goToCourseDetail" data-course-id="{{item.id}}">
                        <!-- å·¦ä¾§æ—¶é—´ -->
                        <view class="course-time">
                            <text class="start-time">{{item.time_start}}</text>
                            <text class="time-separator">~</text>
                            <text class="end-time">{{item.time_end}}</text>
                        </view>

                        <!-- è¯¾ç¨‹ä¿¡æ¯ -->
                        <view class="course-info">
                            <text class="course-name">{{item.course_name}}</text>
                            <view class="course-details">
                                <text class="course-location">{{item.location}}</text>
                                <text class="course-teacher">{{item.teacher}}</text>
                            </view>
                        </view>

                        <!-- å³ä¾§çŠ¶æ€ç¯ -->
                        <view class="status-light {{item.status}}"></view>
                    </view>
                </block>
            </view>
        </view>
    </view>

    <!-- å‘¨è¯¾è¡¨ -->
    <view wx:if="{{selectedTab === 'weekly'}}" class="weekly-container" bindtouchstart="handleTouchStart" bindtouchend="handleTouchEnd">

        <!-- é¡¶éƒ¨æ—¥æœŸæ  -->
        <view class="week-header">
            <view class="empty-cell"></view> <!-- å ä½ï¼Œç¡®ä¿å¯¹é½ -->
            <block wx:for="{{weekDates}}" wx:key="index">
                <view class="day-box">
                    <text class="day-name">{{item.weekday}}</text>
                    <text class="date">{{item.date}}</text>
                </view>
            </block>
        </view>

        <!-- è¯¾ç¨‹ç½‘æ ¼è¡¨ -->
        <scroll-view scroll-y class="week-scroll">
            <view class="week-grid">
                <!-- éå†èŠ‚æ¬¡ -->
                <block wx:for="{{periods}}" wx:key="period" wx:for-item="period">
                    <view class="row">
                        <!-- å·¦ä¾§èŠ‚æ¬¡ -->
                        <view class="week-cell period-label">{{period}}</view>

                        <block wx:for="{{weekDays}}" wx:key="weekday" wx:for-item="weekday">
                            <view class="week-cell course-cell">
                                <!-- åªæ˜¾ç¤ºèµ·å§‹èŠ‚æ¬¡çš„ç›’å­ -->
                                <block wx:if="{{weeklyTimetable[period][weekday].length > 0}}">
                                    <block wx:for="{{weeklyTimetable[period][weekday]}}" wx:for-item="course" wx:key="course.id">
                                        <view class="course-box" style="height: {{course.rowSpan * 120}}rpx;" wx:if="{{period == course.startPeriod}}" bindtap="goToCourseDetail" data-course-id="{{course.id}}">
                                            <text class="classname">{{course.course_name}}</text>
                                            <text class="teacher">{{course.teacher_name}}</text>
                                            <text class="location">{{course.location || "å¾…å®š"}}</text>
                                        </view>
                                    </block>
                                </block>
                            </view>
                        </block>
                    </view>
                </block>
            </view>
        </scroll-view>
    </view>

</view>