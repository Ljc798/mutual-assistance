<view class="page">
    <notify-banner />
    <!-- 上方固定部分 -->
    <view class="header">
        <view class="app-name">首页</view>
        <view class="location-icon">
            <image src="/assets/icons/ditu.svg" class="location-icon-image" bindtap="handleSchoolClick" />
            <span class="location-text" bindtap="handleSchoolClick">{{selectedSchoolName || '请选择学校'}}</span>
        </view>
    </view>

    <!-- 搜索框 -->
    <view class="search-container">
        <view class="search-box">
            <view class="search">
                <image src="/assets/icons/search-magnify-magnifier-glass-svgrepo-com.svg" class="search-icon" />
                <input type="text" class="search-input" placeholder="今天想找点什么呢-_^" bindinput="handleSearchInput" />
            </view>
            <!-- 搜索结果 -->
            <view class="search-results" wx:if="{{searchResults.length > 0}}">
                <block wx:for="{{searchResults}}" wx:key="id">
                    <view class="search-item" bindtap="handleTaskClick" data-index="{{index}}" data-id="{{item.id}}">
                        <text class="search-title">{{item.title}}</text>
                        <text class="search-meta">¥{{item.offer}}</text>
                    </view>
                </block>
            </view>
        </view>
    </view>

    <!-- 分类部分 -->
    <view class="category-container">
        <view class="category-item" bindtap="handleCategoryClick" data-category="代拿快递">
            <image src="/assets/icons/kuaidi.svg" class="category-icon" />
            <text class="category-text">代拿快递</text>
        </view>
        <view class="category-item" bindtap="handleCategoryClick" data-category="代拿外卖">
            <image src="/assets/icons/tongchengwaimai.svg" class="category-icon" />
            <text class="category-text">代拿外卖</text>
        </view>
        <view class="category-item" bindtap="handleCategoryClick" data-category="兼职发布">
            <image src="/assets/icons/jianzhi.svg" class="category-icon" />
            <text class="category-text">兼职发布</text>
        </view>
        <view class="category-item" bindtap="handleCategoryClick" data-category="代办服务">
            <image src="/assets/icons/bangbandaiban.svg" class="category-icon" />
            <text class="category-text">代办服务</text>
        </view>
        <view class="category-item" bindtap="handleTimetableClick">
            <image src="/assets/icons/kebiao.svg" class="category-icon" />
            <text class="category-text">我的课表</text>
        </view>
        <view class="category-item" bindtap="handleCategoryClick" data-category="二手交易">
            <image src="/assets/icons/lanling-ershoujiaoyi.svg" class="category-icon" />
            <text class="category-text">二手交易</text>
        </view>
        <view class="category-item" bindtap="handleCategoryClick" data-category="寻物启事">
            <image src="/assets/icons/shiwuzhaoling.svg" class="category-icon" />
            <text class="category-text">寻物启事</text>
        </view>
        <view class="category-item" bindtap="handleCategoryClick" data-category="作业协助">
            <image src="/assets/icons/zuoye.svg" class="category-icon" />
            <text class="category-text">作业协助</text>
        </view>
        <view class="category-item" bindtap="handleCategoryClick" data-category="万能服务">
            <image src="/assets/icons/fuwu.svg" class="category-icon" />
            <text class="category-text">万能服务</text>
        </view>
        <view class="category-item" bindtap="handleOrderClick">
            <image src="/assets/icons/dingdanrizhi-.svg" class="category-icon" />
            <text class="category-text">我的任务</text>
        </view>
    </view>

    <!-- 待办事项 -->
    <view class="todo-container">
        <view class="todo-header">
            <text class="todo-title">待办</text>
            <view class="todo-actions">
                <button class="todo-add" bindtap="openAddTodo">+</button>
            </view>
        </view>
        <view wx:if="{{todos.length === 0}}" class="todo-empty">暂无待办，点 + 添加</view>
        <scroll-view wx:else class="todo-list-scroll" scroll-y="true">
            <block wx:for="{{todos}}" wx:key="id">
                <view wx:if="{{item.type === 'personal'}}" class="todo-row {{item.isDone ? 'done' : ''}}">
                    <view class="todo-left">
                        <view class="todo-checkbox" bindtap="toggleTodoDone" data-index="{{index}}"></view>
                        <view class="todo-texts" bindtap="openEditTodo" data-index="{{index}}">
                            <view class="todo-title-line">
                                <text class="todo-title">{{item.title}}</text>
                                <text class="todo-pri pri{{item.priority||0}}"></text>
                            </view>
                            <text class="todo-time">{{item.timeText}}</text>
                        </view>
                    </view>
                    <view class="list-actions">
                        <button class="todo-act danger" bindtap="deleteTodo" data-index="{{index}}">删除</button>
                    </view>
                </view>
                <view wx:else class="todo-card {{item.highlight ? 'todo-hot' : ''}}" bindtap="tapTodo" data-index="{{index}}">
                    <view class="todo-type">{{item.type === 'task' ? '任务' : '课程'}}</view>
                    <view class="todo-main">{{item.title}}</view>
                    <view class="todo-time">{{item.timeText}}</view>
                </view>
            </block>
        </scroll-view>
    </view>

    <view wx:if="{{showAddTodoModal}}" class="modal-mask">
        <view class="modal-card">
            <input class="modal-input" placeholder="标题" bindinput="onNewTodoText" value="{{newTodoText}}" />
            <textarea class="modal-textarea" placeholder="内容" bindinput="onNewTodoContent" value="{{newTodoContent}}"></textarea>
            <view class="modal-row">
                <text class="modal-label">优先级</text>
                <picker mode="selector" range="{{['普通','高','紧急']}}" bindchange="onPriorityPicker">
                    <view class="picker-display">{{newTodoPriority==2?'紧急':(newTodoPriority==1?'高':'普通')}}</view>
                </picker>
            </view>
            <view class="modal-row">
                <text class="modal-label">截止日期</text>
                <picker mode="date" start="{{today}}" bindchange="onDueDateChange">
                    <view class="picker-display">{{newDueDate||'请选择日期'}}</view>
                </picker>
            </view>
            <view class="modal-row">
                <text class="modal-label">截止时间</text>
                <picker mode="time" bindchange="onDueTimeChange">
                    <view class="picker-display">{{newDueTime||'请选择时间'}}</view>
                </picker>
            </view>
            <view class="modal-actions">
                <button class="modal-btn cancel" bindtap="closeAddTodo">取消</button>
                <button class="modal-btn ok" bindtap="savePersonalTodo" disabled="{{isSavingTodo}}">保存</button>
            </view>
        </view>
    </view>

    <!-- 筛选条 -->
    <view class="filter-bar">
        <block wx:for="{{filters}}" wx:key="value">
            <view class="filter-item {{activeFilter === item.value ? 'is-active' : ''}}" data-value="{{item.value}}" bindtap="onFilterTap">
                <text class="filter-text">{{item.label}}</text>
            </view>
        </block>
    </view>

    <!-- 任务列表 -->
    <view class="task-list-container">
        <block wx:for="{{tasks}}" wx:key="id">
            <view class="task-item" bindtap="handleTaskClick" data-id="{{item.id}}">
                <view class="task-left">
                    <text class="task-title">{{item.title}}</text>
                    <view class="task-details">
                        <view class="task-time" wx:if="{{item.category !== '二手交易'}}">期望完成时间：{{item.formattedDDL}}前</view>
                        <view class="task-location">交易地点：{{item.position}}</view>
                        <view class="task-address" wx:if="{{item.category !== '二手交易'}}">送达地点：{{item.address}}</view>
                    </view>
                </view>
                <view class="task-right">
                    <view wx:if="{{item.status === 0}}" class="task-status status-pending">{{item.formattedStatus}}</view>
                    <view wx:if="{{item.status === 1}}" class="task-status status-ongoing">{{item.formattedStatus}}</view>
                    <view wx:if="{{item.status === 2}}" class="task-status status-finished">{{item.formattedStatus}}</view>
                    <view class="task-price">
                        <!-- 一口价任务 -->
                        <text wx:if="{{item.mode === 'fixed' && item.status === 0}}" class="price-fixed">一口价 ¥{{item.offer}}</text>
                        <text wx:if="{{item.mode === 'fixed' && item.status === 1}}" class="price-processing">一口价 ¥{{item.offer}}</text>
                        <text wx:if="{{item.mode === 'fixed' && item.status === 2}}" class="price-finished">一口价 ¥{{item.offer}}</text>

                        <!-- 竞价任务 -->
                        <text wx:if="{{item.mode === 'bidding' && item.has_paid === 0}}" class="price-bidding">
                            参考价 ¥{{item.offer}}
                        </text>
                        <text wx:if="{{item.mode === 'bidding' && item.has_paid === 1 && item.status !== 2}}" class="price-deal">
                            中标价 ¥{{item.pay_amount}}
                        </text>
                        <text wx:if="{{item.mode === 'bidding' && item.has_paid === 1 && item.status === 2}}" class="price-finished">
                            成交价 ¥{{item.pay_amount}}
                        </text>
                    </view>
                </view>
            </view>
        </block>
    </view>

    <bottom-nav></bottom-nav>
    <universal-ai></universal-ai>
</view>