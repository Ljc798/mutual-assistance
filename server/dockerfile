# 使用 Node.js 官方镜像（基于 Debian）
FROM node:20.18.0

# 安装 CA 根证书（修复 axios 报 self-signed certificate 的问题）
RUN apt-get update && \
    apt-get install -y ca-certificates && \
    update-ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /app

# 拷贝依赖文件
COPY package*.json ./

# 安装依赖
RUN npm install --omit=dev

# 拷贝项目所有文件
COPY . .

# ✅ 单独复制证书文件夹（根据你目录结构）
COPY cert /app/server/cert

# 设置生产环境变量
ENV NODE_ENV=production

# 启用端口（推荐用 80，云托管默认用）
EXPOSE 80

# 启动服务（端口 80）
CMD ["node", "index.js"]